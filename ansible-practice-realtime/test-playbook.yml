- hosts: server
  become: yes
  become_method: sudo
  tasks:


    - name: installing ifconfig
      ansible.builtin.apt:
        name: "net-tools"
        state: latest

    - name: restarting net adapter
#      net_interface:
#        name: enp0s8
#        state: down
      shell: ifconfig enp0s8 down

    - name: installing python3
      apt: name=python3-pip state=latest

    - name: installing flask with pip
      pip: name=flask state=latest

    - name: Update netplan cfg on test server
      ansible.builtin.template:
        src: server_cfg/00-installer-config.yaml
        dest: /etc/netplan/00-installer-config.yaml
        owner: root
        group: root
        mode: '0644'

    - name: netplan apply
      shell: netplan apply

    - name: ifcfg show
      shell: ifconfig -a
      register: sh_ifcfg

    - name: debug report
      debug: var=sh_ifcfg.stdout_lines

    - name: copying app on srv
      ansible.builtin.template:
        src: server_cfg/app.py
        dest: /home/armitage/app.py
        owner: root
        group: root
        mode: '0644'

    - name: creating_service
      ansible.builtin.template:
        src: server_cfg/web-server.service
        dest: /lib/systemd/system/web-server.service
        owner: root
        group: root
        mode: '0644'

    - name: reloading daemon and enabling service
      ansible.builtin.systemd:
        state: restarted
        daemon-reload: true
        name: web-server
#      shell: systemctl daemon-reload
#      shell: systemctl enable web-server
    - name:
      shell: systemctl status web-server
      register: sh_daemon

    - name: service state
      debug: var=sh_daemon.stdout_lines


- hosts: client
  become: yes
  become_method: sudo
  tasks:
    - name: cfg for client host
      ansible.builtin.template:
          src: client_cfg/00-installer-config.yaml
          dest: /etc/netplan/00-installer-config.yaml
          owner: root
          group: root
          mode: '0644'


- hosts: gateway
  become: yes
  become_method: sudo
  tasks:

    - name: import netplan cfg for gateway
      ansible.builtin.template:
        src: gateway_cfg/00-installer-config.yaml
        dest: /etc/netplan/00-installer-config.yaml
        owner: root
        group: root
        mode: '0644'

    - name: importing iptables rules
      ansible.builtin.template:
        src: gateway_cfg/rules.v4
        dest: /etc/iptables/rules.v4
        owner: root
        group: root
        mode: '0644'

#    - name: apply rules
#      community.general.iptables_state:
#        state: restored
#        path: /run/iptables.apply
#        noflush: true
#      async: "{{ansible_timeout}}"
#      poll: 0
- hosts: client
  become: yes
  become_method: sudo
  tasks:

#    - name: importing script
#      ansible.builtin.template:
#        src: client_cfg/curl_test.sh
#        dest: /home/tolstoy_3
#        owner: tolstoy_3
#        group: tolstoy_3
#        mode: '0744'

    - name: Check that you can connect (GET) to a page and it returns a status 200
      ansible.builtin.uri:
        url: http://192.168.7.10:5000/





